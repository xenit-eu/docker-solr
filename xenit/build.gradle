import com.avast.gradle.dockercompose.tasks.ComposeDown
import com.bmuschko.gradle.docker.tasks.image.Dockerfile.From

subprojects {
    apply plugin: 'eu.xenit.docker'
    apply plugin: 'eu.xenit.docker-compose'

    configurations {
        telemetry
        actuators
        backup
    }

    ext {
        alfredTelemetryVersion = '0.7.2-SNAPSHOT'
        actuatorsVersion = '0.0.2'
        solrBackupVersion = '0.0.3'
        composeDir = "${rootProject.projectDir}/src/integrationTest/resources";
        // atm test without ssl enabled
        tests_use_ssl = false
        composeFiles = ["$composeDir/docker-compose-alfresco-non-ssl.yml",
                           "$composeDir/docker-compose-solr-non-ssl.yml",
                           "$composeDir/docker-compose-db.yml"];
    }

    dependencies {
        actuators("eu.xenit.solr-actuators:solr-actuators:${actuatorsVersion}")
        backup("eu.xenit.solr-backup:solr-backup:${solrBackupVersion}")
    }

    if (new File("${project.projectDir}/overload.gradle").exists())
        apply from: "${project.projectDir}/overload.gradle"


    def upstreamProjectName = ":upstream:${project.name}"
    def upstreamProject = project(upstreamProjectName)
    evaluationDependsOn(upstreamProjectName)
    def upstreamImage = upstreamProject.getTasks().getByName('buildDockerImage')
    buildDockerImage.dependsOn(upstreamImage)
    createDockerFile.dependsOn(upstreamImage)

    buildDockerImage {
        pull = false
    }

    dockerFile {
        dockerBuild {
            def enterprise = upstreamProject.alfrescoimage.contains("enterprise")
            repository = [calcRepository(upstreamProject.solr.flavor,enterprise,true)].get(0)
            tags = calcTags(upstreamProject.solr.version)
        }
    }


    createDockerFile {
        from(upstreamImage.getImageId().map({ new From(it) }))
        // micrometer handler init script
        smartCopy("${project.projectDir}/../local/95-init-solr-micrometer-metrics.sh","/docker-entrypoint.d/")
        // jmx needs to be enabled
        environmentVariable 'JMX_ENABLED', 'true'
        if("solr4".equals(upstreamProject.solr.flavor)) {
            environmentVariable 'METRICS_TOMCAT_ENABLED', 'true'
            smartCopy("${project.projectDir}/../local/solrconfig.xml","/opt/alfresco/solr4/workspace-SpacesStore/conf/solrconfig.xml")
            smartCopy files(configurations.telemetry.files), "/opt/alfresco/solr4/lib/"
            smartCopy files(configurations.actuators.files), "/opt/alfresco/solr4/lib/"
            label([
                    "eu.xenit.prometheus.metrics-path":"/solr4/alfresco/metrics",
                    "eu.xenit.prometheus.params":"wt: ['dummy']"
            ])
        } else if("solr6".equals(upstreamProject.solr.flavor)) {
            // telemetry
            environmentVariable 'METRICS_JETTY_ENABLED', 'true'
            smartCopy "${project.projectDir}/../local/solrconfig_insight.xml", "/opt/alfresco-search-services/solrhome/templates/rerank/conf/solrconfig_insight.xml"
            smartCopy "${project.projectDir}/../local/jetty.xml", "/opt/alfresco-search-services/solr/server/etc/jetty.xml"
            smartCopy "${project.projectDir}/../local/solr-jetty-context.xml", "/opt/alfresco-search-services/solr/server/contexts/solr-jetty-context.xml"
            smartCopy files(configurations.telemetry.files), "/opt/alfresco-search-services/solrhome/lib/"
            label([
                    "eu.xenit.prometheus.metrics-path":"/solr/alfresco/metrics",
                    "eu.xenit.prometheus.params":"wt: ['dummy']"
            ])
            // actuators
            smartCopy files(configurations.actuators.files), "/opt/alfresco-search-services/solrhome/lib/"
            // backup
            smartCopy files(configurations.backup.files), "/opt/alfresco-search-services/solrhome/lib/"
            smartCopy("${project.projectDir}/../local/93-restore-from-backup.sh","/docker-entrypoint.d/")
            smartCopy("${project.projectDir}/../local/solr.xml","/opt/alfresco-search-services/solrhome/solr.xml")
        }
    }

    task integrationTestXenitEndpoints(type: Test, group: "verification") {
        enabled = (project.hasProperty('tests') && project.tests)

        testClassesDirs = sourceSets.integrationTest.output.classesDirs
        classpath = sourceSets.integrationTest.runtimeClasspath
        outputs.upToDateWhen { false }

        doFirst {
            dockerCompose.exposeAsSystemProperties(integrationTestXenitEndpoints)
            systemProperty("flavor", "${upstreamProject.solr.flavor}")
            systemProperty("telemetry", true)
            systemProperty("actuators", true)
            systemProperty("use_ssl", tests_use_ssl)
            systemProperty("keystore", "${rootProject.projectDir}/src/main/resources/global/keystore/ssl.repo.client.keystore")
            systemProperty("truststore", "${rootProject.projectDir}/src/main/resources/global/keystore/ssl.repo.client.truststore")
        }
    }

    task integrationTests(type: Test, group: "verification") {
        dependsOn integrationTestXenitEndpoints
    }

    dockerCompose {
        environment.put 'ALFRESCO_IMAGE', upstreamProject.alfrescoimage
        environment.put 'INDEX', upstreamProject.solr.flavor

        isRequiredBy(project.tasks.integrationTestXenitEndpoints)

        useComposeFiles = composeFiles
    }

    task composeDownAll {
        dependsOn project.tasks.withType(ComposeDown)
    }
}
